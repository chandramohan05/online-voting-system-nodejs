<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin - Create Election</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/styles.css" rel="stylesheet">
  </head>
  <body class="p-4">
    <div class="navbar"><div class="container-card"><strong>Admin</strong></div></div>
    <div class="container-card">
      <div class="card">
        <div id="loginDiv">
          <h3>Admin Login</h3>
          <form id="loginForm">
            <div class="mb-3">
              <label class="form-label">Username</label>
              <input class="form-control" name="username" placeholder="Enter admin username" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Password</label>
              <input class="form-control" name="password" placeholder="Enter admin password" type="password" required>
            </div>
            <button class="btn btn-primary" type="submit">Login to Admin Panel</button>
          </form>
        </div>

        <div id="adminArea" style="display:none">
          <h3>Create Election</h3>
          <form id="createForm">
            <div class="mb-3"><input id="ename" class="form-control" placeholder="Election name" required></div>
            <div class="mb-3"><textarea id="participants" class="form-control" placeholder="One participant name per line" rows="4" required></textarea></div>
            <button class="btn btn-success">Create</button>
          </form>

          <hr>
          <h3>Elections and Results</h3>
          <div id="electionsList"></div>
          
          <hr>
          <h3>Detailed Results</h3>
          <div id="detailedResults" class="mt-3"></div>
        </div>
      </div>
    </div>

    <script>
      // Check admin session on every page load
      async function checkAdminSession() {
        try {
          const response = await fetch('/admin/check-session', {
            credentials: 'include'
          });
          if (response.ok) {
            const data = await response.json();
            if (data.ok) {
              showAdminArea();
              return true;
            }
          }
          document.getElementById('loginDiv').style.display = 'block';
          document.getElementById('adminArea').style.display = 'none';
          return false;
        } catch (error) {
          console.error('Session check failed:', error);
          document.getElementById('loginDiv').style.display = 'block';
          document.getElementById('adminArea').style.display = 'none';
          return false;
        }
      }

      // Initial session check
      window.addEventListener('load', checkAdminSession);

      document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        const username = fd.get('username');
        const password = fd.get('password');
        try {
          const r = await fetch('/admin/login', { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify({username, password}),
            credentials: 'include'
          });
          const data = await r.json();
          if (r.ok) { 
            // After successful login, wait a bit for the session to be saved
            setTimeout(() => {
              window.location.reload();
            }, 100);
          } else { 
            alert('Login failed: ' + (data.error || 'Unknown error')); 
          }
        } catch(err) {
          console.error('Login error:', err);
          alert('Login failed: ' + err.message);
        }
      });

      function showAdminArea(){ 
        document.getElementById('loginDiv').style.display = 'none'; 
        document.getElementById('adminArea').style.display = 'block'; 
        loadElections(); 
      }

      document.getElementById('createForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('ename').value.trim();
        const parts = document.getElementById('participants').value.split('\n')
          .map(s => s.trim()).filter(Boolean);
        
        try {
          const r = await fetch('/admin/elections', { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            credentials: 'include',
            body: JSON.stringify({name, participants: parts}) 
          });
          const j = await r.json();
          if (r.ok) { 
            alert('Election created successfully'); 
            loadElections(); 
          } else { 
            alert('Error: ' + (j.error || 'Unknown error')); 
          }
        } catch(err) {
          console.error('Error creating election:', err);
          alert('Failed to create election: ' + err.message);
        }
      });

      async function loadElections(){
        try {
          const r = await fetch('/admin/elections', {
            credentials: 'include'
          });
          if (r.status === 401) { 
            document.getElementById('loginDiv').style.display = 'block';
            document.getElementById('adminArea').style.display = 'none';
            return; 
          }
          const j = await r.json();
        const cont = document.getElementById('electionsList'); 
        cont.innerHTML='';
        
        for(const e of j){
          const div = document.createElement('div'); 
          div.className='card p-2 mb-2';
          const totalVotes = e.participants.reduce((sum, p) => sum + p.votes, 0);
          const resultsHtml = e.participants.map(p => {
            const percentage = totalVotes > 0 ? ((p.votes / totalVotes) * 100).toFixed(1) : 0;
            return `
              <div class="mb-2">
                <div class="d-flex justify-content-between">
                  <span>${p.name}</span>
                  <span>${p.votes} votes (${percentage}%)</span>
                </div>
                <div class="progress">
                  <div class="progress-bar" role="progressbar" style="width: ${percentage}%" 
                       aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
              </div>`;
          }).join('');
          
          div.innerHTML = `
            <h4>${e.name}</h4>
            <div class="mt-2">Total Votes: ${totalVotes}</div>
            <div class="mt-3">${resultsHtml}</div>
            <button class="btn btn-sm btn-outline-primary mt-2" onclick="showDetailedResults('${e.id}')">
              View Detailed Results
            </button>`;
            cont.appendChild(div);
          }
        } catch (error) {
          console.error('Error loading elections:', error);
          alert('Failed to load elections');
        }
      }
  
        async function showDetailedResults(electionId) {
        try {
          const r = await fetch(`/admin/election-details/${electionId}`);
          if (!r.ok) throw new Error('Failed to fetch details');
          const data = await r.json();
          
          const detailedResults = document.getElementById('detailedResults');
          detailedResults.innerHTML = `
            <div class="card p-3">
              <h5>${data.election.name} - Detailed Results</h5>
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Voter ID</th>
                      <th>Vote Time</th>
                      <th>Voted For</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${data.votes.map(v => `
                      <tr>
                        <td>${v.voterId}</td>
                        <td>${new Date(v.created_at).toLocaleString()}</td>
                        <td>${v.participantName}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          `;
        } catch (error) {
          console.error('Error loading detailed results:', error);
          alert('Failed to load detailed results');
        }
      }

      // Check admin session on page load
      // (already handled above with window.addEventListener('load', checkAdminSession);)
    </script>
  </body>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</html>
